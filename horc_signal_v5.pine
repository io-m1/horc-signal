//@version=6
indicator("HORC v5.0", overlay=false, max_bars_back=500)

or_minutes = input.int(30, "OR Window", minval=15, maxval=120, group="Settings")
cps_threshold = input.float(0.50, "Signal Threshold", minval=0.3, maxval=0.9, step=0.05, group="Settings")
show_signals = input.bool(true, "Show Signals on Chart", group="Display")
show_histogram = input.bool(true, "Show Histogram", group="Display")

var float orh = na
var float orl = na
var bool or_complete = false
var int or_bar = na
var int participant = 0
var float defended = na
var string state = "WAIT"
var int move1_bar = na
var float move1_price = na
var int flip_bar = na
var float flip_price = na
var int signal_dir = 0
var float entry = na
var float stop_loss = na
var float target = na
var float cps = 0.0
var float hist_value = 0.0

is_new_day = ta.change(time("D")) != 0
is_session = not na(time(timeframe.period, "0930-1600:23456"))
sess_start = timestamp(year, month, dayofmonth, 9, 30, 0)
or_end_time = sess_start + or_minutes * 60 * 1000
in_or = is_session and time >= sess_start and time < or_end_time and not or_complete

atr = ta.atr(14)
avg_vol = ta.sma(volume, 20)
vol_ratio = avg_vol > 0 ? volume / avg_vol : 1.0

if is_new_day
    orh := na
    orl := na
    or_complete := false
    or_bar := na
    participant := 0
    defended := na
    state := "WAIT"
    move1_bar := na
    move1_price := na
    flip_bar := na
    flip_price := na
    signal_dir := 0
    cps := 0.0

if in_or
    orh := na(orh) ? high : math.max(orh, high)
    orl := na(orl) ? low : math.min(orl, low)

if not na(orh) and not na(orl) and time >= or_end_time and not or_complete
    or_complete := true
    or_bar := bar_index
    state := "SCAN"

if or_complete and participant == 0 and state == "SCAN"
    bars_after = bar_index - or_bar
    if bars_after >= 0 and bars_after <= 3
        swept_low = low <= orl
        swept_high = high >= orh
        if swept_low and not swept_high
            participant := -1
            defended := orl
            move1_price := low
            state := "MOVE1"
        else if swept_high and not swept_low
            participant := 1
            defended := orh
            move1_price := high
            state := "MOVE1"
        else if swept_low and swept_high
            low_pen = orl - low
            high_pen = high - orh
            if low_pen > high_pen
                participant := -1
                defended := orl
                move1_price := low
            else
                participant := 1
                defended := orh
                move1_price := high
            state := "MOVE1"
    else if bars_after > 3 and participant == 0
        state := "FAIL"

if state == "MOVE1" and participant != 0
    if participant == -1
        if low < move1_price
            move1_price := low
        if close > move1_price + atr * 0.5
            state := "MOVE2"
            move1_bar := bar_index
    else if participant == 1
        if high > move1_price
            move1_price := high
        if close < move1_price - atr * 0.5
            state := "MOVE2"
            move1_bar := bar_index

if state == "MOVE2"
    body = math.abs(close - open)
    range_size = high - low
    body_ratio = range_size > 0 ? body / range_size : 0.5
    
    upper_wick = high - math.max(open, close)
    lower_wick = math.min(open, close) - low
    
    exhaust_score = 0.0
    if participant == -1
        wick_score = range_size > 0 ? lower_wick / range_size : 0
        exhaust_score := (1.0 - body_ratio) * 0.5 + wick_score * 0.5
    else
        wick_score = range_size > 0 ? upper_wick / range_size : 0
        exhaust_score := (1.0 - body_ratio) * 0.5 + wick_score * 0.5
    
    if exhaust_score > 0.4
        flip_price := participant == -1 ? high : low
        flip_bar := bar_index
        state := "FLIP"

if state == "FLIP"
    bars_since = bar_index - flip_bar
    if bars_since > 15
        state := "FAIL"
    else
        if participant == -1
            if close > move1_price
                state := "SIGNAL"
        else
            if close < move1_price
                state := "SIGNAL"

part_score = participant != 0 ? 0.4 : 0.0
wave_score = state == "SIGNAL" or state == "FLIP" ? 0.35 : state == "MOVE2" ? 0.2 : 0.0
vol_score = vol_ratio > 1.2 ? 0.15 : vol_ratio > 0.8 ? 0.1 : 0.05
cps := part_score + wave_score + vol_score

hist_value := participant == 1 ? cps : participant == -1 ? -cps : 0.0

buy_signal = state == "SIGNAL" and participant == -1 and cps >= cps_threshold and signal_dir != 1
sell_signal = state == "SIGNAL" and participant == 1 and cps >= cps_threshold and signal_dir != -1

if buy_signal
    signal_dir := 1
    entry := close
    stop_loss := math.min(orl, flip_price) - atr * 0.5
    target := entry + (entry - stop_loss) * 2.0
    state := "ACTIVE"

if sell_signal
    signal_dir := -1
    entry := close
    stop_loss := math.max(orh, flip_price) + atr * 0.5
    target := entry - (stop_loss - entry) * 2.0
    state := "ACTIVE"

if state == "ACTIVE" and signal_dir != 0
    if signal_dir == 1
        if high >= target or low <= stop_loss
            signal_dir := 0
            state := "DONE"
    else if signal_dir == -1
        if low <= target or high >= stop_loss
            signal_dir := 0
            state := "DONE"

hist_color = hist_value > cps_threshold ? color.new(color.green, 20) : hist_value < -cps_threshold ? color.new(color.red, 20) : hist_value > 0 ? color.new(color.green, 60) : hist_value < 0 ? color.new(color.red, 60) : color.new(color.gray, 80)

plot(show_histogram ? hist_value : na, "HORC", color=hist_color, style=plot.style_columns, linewidth=4)
hline(cps_threshold, "Buy Threshold", color.new(color.green, 70), linestyle=hline.style_dashed)
hline(-cps_threshold, "Sell Threshold", color.new(color.red, 70), linestyle=hline.style_dashed)
hline(0, "Zero", color.new(color.gray, 50))

signal_line = ta.ema(hist_value, 5)
plot(signal_line, "Signal", color.new(color.orange, 0), linewidth=2)

plotshape(buy_signal and show_signals ? -1.0 : na, "Long", shape.triangleup, location.absolute, color.green, size=size.small)
plotshape(sell_signal and show_signals ? 1.0 : na, "Short", shape.triangledown, location.absolute, color.red, size=size.small)

bgcolor(state == "ACTIVE" and signal_dir == 1 ? color.new(color.green, 95) : state == "ACTIVE" and signal_dir == -1 ? color.new(color.red, 95) : na)

alertcondition(buy_signal, "HORC Long", "HORC Long Signal")
alertcondition(sell_signal, "HORC Short", "HORC Short Signal")

var table info = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 85))
if barstate.islast
    table.cell(info, 0, 0, "HORC v5", text_color=color.white, text_size=size.normal)
    table.cell(info, 1, 0, state, text_color=color.yellow, text_size=size.small)
    table.cell(info, 0, 1, "Participant", text_color=color.gray, text_size=size.small)
    p_txt = participant == 1 ? "BUYER" : participant == -1 ? "SELLER" : "---"
    p_col = participant == 1 ? color.green : participant == -1 ? color.red : color.gray
    table.cell(info, 1, 1, p_txt, text_color=p_col, text_size=size.small)
    table.cell(info, 0, 2, "CPS", text_color=color.gray, text_size=size.small)
    cps_col = math.abs(cps) >= cps_threshold ? color.lime : color.gray
    table.cell(info, 1, 2, str.tostring(math.round(cps * 100)) + "%", text_color=cps_col, text_size=size.small)
    table.cell(info, 0, 3, "Signal", text_color=color.gray, text_size=size.small)
    sig_txt = signal_dir == 1 ? "LONG" : signal_dir == -1 ? "SHORT" : "NONE"
    sig_col = signal_dir == 1 ? color.green : signal_dir == -1 ? color.red : color.gray
    table.cell(info, 1, 3, sig_txt, text_color=sig_col, text_size=size.small)
    table.cell(info, 0, 4, "Entry", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 4, signal_dir != 0 ? str.tostring(math.round(entry, 5)) : "---", text_color=color.white, text_size=size.small)
    table.cell(info, 0, 5, "Target", text_color=color.gray, text_size=size.small)
    table.cell(info, 1, 5, signal_dir != 0 ? str.tostring(math.round(target, 5)) : "---", text_color=color.white, text_size=size.small)
