//@version=6
indicator("HORC v6.0", overlay=false, max_bars_back=500)

or_minutes = input.int(30, "OR Minutes", minval=15, maxval=120, group="Core")
cps_threshold = input.float(0.40, "CPS Threshold", minval=0.2, maxval=0.8, step=0.05, group="Core")
use_fx_sessions = input.bool(true, "FX Sessions (London/NY)", group="Core")

london_start = input.session("0800-0830", "London OR", group="Sessions")
ny_start = input.session("1400-1430", "NY OR", group="Sessions")

show_histogram = input.bool(true, "Histogram", group="Display")
show_signals = input.bool(true, "Signals", group="Display")
show_table = input.bool(true, "Info Table", group="Display")

NONE = 0
BUYER = 1
SELLER = -1

ABS_NONE = 0
ABS_EXHAUSTION = 1
ABS_INTERNAL = 2
ABS_EXTERNAL = 3

var float orh = na
var float orl = na
var bool or_done = false
var int or_bar = na

var int participant = NONE
var float defended = na
var int charge_D = NONE
var int charge_S = NONE

var string wl_state = "PRE_OR"
var float move1_ext = na
var float move2_ext = na
var float flip_pt = na
var int flip_bar = na
var int moves = 0

var float intent = 0.0
var int intent_bars = 0

var int abs_type = ABS_NONE
var float div_score = 0.0
var bool is_internal = false
var bool is_external = false

var int sig_dir = 0
var float entry_px = na
var float sl_px = na
var float tp_px = na
var float cps = 0.0

is_new_day = ta.change(time("D")) != 0

in_london_or = use_fx_sessions and not na(time(timeframe.period, london_start))
in_ny_or = use_fx_sessions and not na(time(timeframe.period, ny_start))
in_or = in_london_or or in_ny_or

atr = ta.atr(14)
vol_avg = ta.sma(volume, 20)
vol_rat = vol_avg > 0 ? volume / vol_avg : 1.0

body = math.abs(close - open)
rng = high - low
body_rat = rng > 0 ? body / rng : 0.5
upper_wick = high - math.max(open, close)
lower_wick = math.min(open, close) - low

if is_new_day
    orh := na
    orl := na
    or_done := false
    or_bar := na
    participant := NONE
    defended := na
    charge_D := NONE
    charge_S := NONE
    wl_state := "PRE_OR"
    move1_ext := na
    move2_ext := na
    flip_pt := na
    flip_bar := na
    moves := 0
    intent := 0.0
    intent_bars := 0
    abs_type := ABS_NONE
    div_score := 0.0
    is_internal := false
    is_external := false
    sig_dir := 0

if in_or and not or_done
    orh := na(orh) ? high : math.max(orh, high)
    orl := na(orl) ? low : math.min(orl, low)

if not na(orh) and not na(orl) and not in_or and not or_done and orh > orl
    or_done := true
    or_bar := bar_index
    wl_state := "SCAN"

if or_done and participant == NONE and wl_state == "SCAN"
    bars_post = bar_index - or_bar
    if bars_post >= 1 and bars_post <= 3
        swept_l = low <= orl
        swept_h = high >= orh
        if swept_l and not swept_h
            participant := SELLER
            defended := orl
            move1_ext := low
            charge_D := SELLER
            charge_S := SELLER
            wl_state := "MOVE1"
        else if swept_h and not swept_l
            participant := BUYER
            defended := orh
            move1_ext := high
            charge_D := BUYER
            charge_S := BUYER
            wl_state := "MOVE1"
        else if swept_l and swept_h
            l_pen = orl - low
            h_pen = high - orh
            if l_pen > h_pen
                participant := SELLER
                defended := orl
                move1_ext := low
                charge_D := SELLER
            else
                participant := BUYER
                defended := orh
                move1_ext := high
                charge_D := BUYER
            charge_S := participant
            wl_state := "MOVE1"
    else if bars_post > 3 and participant == NONE
        wl_state := "FAIL"

if wl_state == "MOVE1" and participant != NONE
    if participant == SELLER
        if low < move1_ext
            move1_ext := low
        if close > move1_ext + atr * 0.5
            wl_state := "MOVE2"
            moves := 1
    else
        if high > move1_ext
            move1_ext := high
        if close < move1_ext - atr * 0.5
            wl_state := "MOVE2"
            moves := 1

if wl_state == "MOVE2"
    if participant == SELLER
        if na(move2_ext) or high > move2_ext
            move2_ext := high
    else
        if na(move2_ext) or low < move2_ext
            move2_ext := low
    
    exhaust = 0.0
    if participant == SELLER
        wick_sc = rng > 0 ? upper_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    else
        wick_sc = rng > 0 ? lower_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    
    if exhaust > 0.35
        flip_pt := move2_ext
        flip_bar := bar_index
        wl_state := "FLIP"
        moves := 2
        
        if not na(defended) and not na(flip_pt)
            dist_to_def = math.abs(flip_pt - defended)
            move_size = not na(move1_ext) ? math.abs(move1_ext - defended) : atr * 2
            retrace = move_size > 0 ? dist_to_def / move_size : 0.5
            
            if retrace < 0.5
                is_internal := true
                abs_type := ABS_INTERNAL
            else
                is_external := true
                abs_type := ABS_EXTERNAL

if wl_state == "FLIP"
    bars_s = bar_index - flip_bar
    if bars_s > 20
        wl_state := "FAIL"
    else
        confirmed = false
        if participant == SELLER
            if close > move1_ext
                confirmed := true
        else
            if close < move1_ext
                confirmed := true
        
        if confirmed
            wl_state := "MOVE3"
            moves := 3

if wl_state == "MOVE3"
    if participant == SELLER
        if close > defended
            wl_state := "COMPLETE"
    else
        if close < defended
            wl_state := "COMPLETE"

if participant != NONE
    force = 0.0
    if participant == SELLER
        force := (defended - close) / atr if atr > 0 else 0
    else
        force := (close - defended) / atr if atr > 0 else 0
    
    intent += force * 0.1
    intent *= 0.995
    
    if (intent > 0 and intent[1] > 0) or (intent < 0 and intent[1] < 0)
        intent_bars += 1
    else
        intent_bars := 0

if not na(move1_ext) and not na(move2_ext) and participant != NONE
    passive_dir = participant == SELLER ? 1 : -1
    aggr_dir = participant
    
    if passive_dir != aggr_dir
        div_score := 0.5
        if abs_type == ABS_EXTERNAL
            div_score := 0.8
        else if abs_type == ABS_INTERNAL
            div_score := 0.3

part_sc = participant != NONE ? 0.35 : 0.0
wave_sc = wl_state == "MOVE3" or wl_state == "COMPLETE" ? 0.30 : wl_state == "FLIP" ? 0.20 : wl_state == "MOVE2" ? 0.10 : 0.0
vol_sc = vol_rat > 1.5 ? 0.15 : vol_rat > 1.0 ? 0.10 : 0.05
intent_sc = math.abs(intent) > 0.5 ? 0.10 : 0.0
div_sc = div_score * 0.10

base_cps = part_sc + wave_sc + vol_sc + intent_sc + div_sc

intent_aligned = (participant == BUYER and intent > 0) or (participant == SELLER and intent < 0)
intent_mult = intent_aligned ? 1.0 + math.min(math.abs(intent) * 0.2, 0.3) : 0.7

abs_mult = 1.0
if abs_type == ABS_INTERNAL
    abs_mult := div_score > 0.3 ? 0.85 : 1.1
else if abs_type == ABS_EXTERNAL
    abs_mult := div_score > 0.5 ? 1.2 : 1.0

cps := base_cps * intent_mult * abs_mult
cps := math.max(0.0, math.min(1.0, cps))

hist_val = participant == BUYER ? cps : participant == SELLER ? -cps : 0.0

buy_cond = wl_state == "MOVE3" and participant == SELLER and cps >= cps_threshold and sig_dir != 1
sell_cond = wl_state == "MOVE3" and participant == BUYER and cps >= cps_threshold and sig_dir != -1

cont_buy = is_internal and participant == BUYER and wl_state == "FLIP" and cps >= cps_threshold * 0.9 and sig_dir != 1
cont_sell = is_internal and participant == SELLER and wl_state == "FLIP" and cps >= cps_threshold * 0.9 and sig_dir != -1

buy_sig = buy_cond or cont_buy
sell_sig = sell_cond or cont_sell

if buy_sig and sig_dir != 1
    sig_dir := 1
    entry_px := close
    sl_px := math.min(orl, flip_pt) - atr * 0.5
    tp_px := entry_px + (entry_px - sl_px) * 2.0
    wl_state := "ACTIVE"

if sell_sig and sig_dir != -1
    sig_dir := -1
    entry_px := close
    sl_px := math.max(orh, flip_pt) + atr * 0.5
    tp_px := entry_px - (sl_px - entry_px) * 2.0
    wl_state := "ACTIVE"

if wl_state == "ACTIVE" and sig_dir != 0
    hit_tp = sig_dir == 1 ? high >= tp_px : low <= tp_px
    hit_sl = sig_dir == 1 ? low <= sl_px : high >= sl_px
    if hit_tp or hit_sl
        sig_dir := 0
        wl_state := "DONE"

h_col = hist_val > cps_threshold ? color.new(color.green, 20) : hist_val < -cps_threshold ? color.new(color.red, 20) : hist_val > 0 ? color.new(color.green, 60) : hist_val < 0 ? color.new(color.red, 60) : color.new(color.gray, 80)

plot(show_histogram ? hist_val : na, "CPS", color=h_col, style=plot.style_columns, linewidth=4)
hline(cps_threshold, "Long Zone", color.new(color.green, 70), linestyle=hline.style_dashed)
hline(-cps_threshold, "Short Zone", color.new(color.red, 70), linestyle=hline.style_dashed)
hline(0, "Zero", color.new(color.gray, 50))

sig_line = ta.ema(hist_val, 5)
plot(sig_line, "Signal Line", color.new(color.orange, 0), linewidth=2)

plotshape(buy_sig and show_signals ? -0.8 : na, "Long", shape.triangleup, location.absolute, color.green, size=size.small)
plotshape(sell_sig and show_signals ? 0.8 : na, "Short", shape.triangledown, location.absolute, color.red, size=size.small)

bgcolor(wl_state == "ACTIVE" and sig_dir == 1 ? color.new(color.green, 95) : wl_state == "ACTIVE" and sig_dir == -1 ? color.new(color.red, 95) : na)

alertcondition(buy_sig, "HORC Long", "HORC Long Entry")
alertcondition(sell_sig, "HORC Short", "HORC Short Entry")

var table tbl = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 85))
if show_table and barstate.islast
    table.cell(tbl, 0, 0, "HORC v6", text_color=color.white, text_size=size.normal)
    table.cell(tbl, 1, 0, wl_state, text_color=color.yellow, text_size=size.small)
    
    table.cell(tbl, 0, 1, "Participant", text_color=color.gray, text_size=size.small)
    p_txt = participant == BUYER ? "BUYER" : participant == SELLER ? "SELLER" : "NONE"
    p_col = participant == BUYER ? color.green : participant == SELLER ? color.red : color.gray
    table.cell(tbl, 1, 1, p_txt, text_color=p_col, text_size=size.small)
    
    table.cell(tbl, 0, 2, "Absorption", text_color=color.gray, text_size=size.small)
    abs_txt = abs_type == ABS_INTERNAL ? "INTERNAL" : abs_type == ABS_EXTERNAL ? "EXTERNAL" : abs_type == ABS_EXHAUSTION ? "EXHAUST" : "NONE"
    abs_col = abs_type == ABS_INTERNAL ? color.blue : abs_type == ABS_EXTERNAL ? color.purple : color.gray
    table.cell(tbl, 1, 2, abs_txt, text_color=abs_col, text_size=size.small)
    
    table.cell(tbl, 0, 3, "Divergence", text_color=color.gray, text_size=size.small)
    table.cell(tbl, 1, 3, str.tostring(math.round(div_score * 100)) + "%", text_color=div_score > 0.5 ? color.orange : color.gray, text_size=size.small)
    
    table.cell(tbl, 0, 4, "Intent", text_color=color.gray, text_size=size.small)
    int_col = intent > 0.3 ? color.green : intent < -0.3 ? color.red : color.gray
    table.cell(tbl, 1, 4, str.tostring(math.round(intent * 100) / 100), text_color=int_col, text_size=size.small)
    
    table.cell(tbl, 0, 5, "CPS", text_color=color.gray, text_size=size.small)
    cps_col = cps >= cps_threshold ? color.lime : color.gray
    table.cell(tbl, 1, 5, str.tostring(math.round(cps * 100)) + "%", text_color=cps_col, text_size=size.small)
    
    table.cell(tbl, 0, 6, "Signal", text_color=color.gray, text_size=size.small)
    sig_txt = sig_dir == 1 ? "LONG" : sig_dir == -1 ? "SHORT" : "FLAT"
    sig_col = sig_dir == 1 ? color.green : sig_dir == -1 ? color.red : color.gray
    table.cell(tbl, 1, 6, sig_txt, text_color=sig_col, text_size=size.small)
    
    table.cell(tbl, 0, 7, "Moves", text_color=color.gray, text_size=size.small)
    table.cell(tbl, 1, 7, str.tostring(moves) + "/3", text_color=moves >= 2 ? color.lime : color.gray, text_size=size.small)
