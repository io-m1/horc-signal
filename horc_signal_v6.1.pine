//@version=6
indicator("HORC v6.1-C (Continuation)", overlay=false, max_bars_back=500)

or_minutes = input.int(30, "OR Minutes", minval=15, maxval=120, group="Core")
cps_threshold = input.float(0.35, "CPS Threshold", minval=0.2, maxval=0.7, step=0.05, group="Core")
use_fx_sessions = input.bool(true, "FX Sessions", group="Core")

london_start = input.session("0800-0830", "London OR", group="Sessions")
ny_start = input.session("1400-1430", "NY OR", group="Sessions")

show_histogram = input.bool(true, "Histogram", group="Display")
show_signals = input.bool(true, "Signals", group="Display")

NONE = 0
BUYER = 1
SELLER = -1

ABS_NONE = 0
ABS_EXHAUSTION = 1
ABS_INTERNAL = 2
ABS_EXTERNAL = 3

var float orh = na
var float orl = na
var bool or_done = false
var int or_bar = na
var int or_bias = NONE

var int participant = NONE
var float defended = na
var float move1_ext = na

var float intent = 0.0
var int abs_type = ABS_NONE
var float conflict_score = 0.0

var int sig_dir = 0
var string sig_type = ""

is_new_day = ta.change(time("D")) != 0
in_london_or = use_fx_sessions and not na(time(timeframe.period, london_start))
in_ny_or = use_fx_sessions and not na(time(timeframe.period, ny_start))
in_or = in_london_or or in_ny_or

atr = ta.atr(14)
vol_avg = ta.sma(volume, 20)
vol_rat = vol_avg > 0 ? volume / vol_avg : 1.0

if is_new_day
    orh := na
    orl := na
    or_done := false
    or_bar := na
    or_bias := NONE
    participant := NONE
    defended := na
    move1_ext := na
    intent := 0.0
    abs_type := ABS_NONE
    conflict_score := 0.0
    sig_dir := 0
    sig_type := ""

if in_or and not or_done
    orh := na(orh) ? high : math.max(orh, high)
    orl := na(orl) ? low : math.min(orl, low)

if not na(orh) and not na(orl) and not in_or and not or_done and orh > orl
    or_done := true
    or_bar := bar_index
    or_bias := close > (orh + orl) / 2 ? BUYER : SELLER

if or_done and participant == NONE
    bars_post = bar_index - or_bar
    if bars_post >= 1 and bars_post <= 5
        swept_l = low <= orl
        swept_h = high >= orh
        if swept_l and not swept_h
            participant := SELLER
            defended := orl
            move1_ext := low
        else if swept_h and not swept_l
            participant := BUYER
            defended := orh
            move1_ext := high
        else if swept_l and swept_h
            l_pen = orl - low
            h_pen = high - orh
            participant := l_pen > h_pen ? SELLER : BUYER
            defended := participant == SELLER ? orl : orh
            move1_ext := participant == SELLER ? low : high

if participant != NONE
    if participant == SELLER
        if low < move1_ext
            move1_ext := low
    else
        if high > move1_ext
            move1_ext := high
    
    body = math.abs(close - open)
    rng = high - low
    body_rat = rng > 0 ? body / rng : 0.5
    upper_wick = high - math.max(open, close)
    lower_wick = math.min(open, close) - low
    
    exhaust = 0.0
    if participant == SELLER
        wick_sc = rng > 0 ? upper_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    else
        wick_sc = rng > 0 ? lower_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    
    if exhaust > 0.4 and rng > atr * 0.4
        retrace_pt = participant == SELLER ? high : low
        
        if not na(defended) and not na(move1_ext)
            dist_to_def = math.abs(retrace_pt - defended)
            move_size = math.abs(move1_ext - defended)
            retrace_rat = move_size > 0 ? dist_to_def / move_size : 0.5
            
            if retrace_rat < 0.5
                abs_type := ABS_INTERNAL
            else if retrace_rat >= 0.5
                abs_type := ABS_EXTERNAL
            else
                abs_type := ABS_EXHAUSTION
    
    force = 0.0
    if participant == SELLER
        force := (defended - close) / atr if atr > 0 else 0
    else
        force := (close - defended) / atr if atr > 0 else 0
    
    intent += force * 0.1
    intent *= 0.995
    
    price_progress = math.abs(close - defended)
    effort = vol_rat
    expected_progress = effort * atr
    actual_progress = price_progress
    efficiency = expected_progress > 0 ? actual_progress / expected_progress : 1.0
    
    if efficiency < 0.5
        conflict_score := 0.65
    else if efficiency < 0.8
        conflict_score := 0.25
    else
        conflict_score := 0.0
    
    bars_since_def = bar_index - or_bar
    decay = math.max(0.0, 1.0 - bars_since_def / 100.0)
    
    part_sc = 0.30
    vol_sc = vol_rat > 1.3 ? 0.15 : vol_rat > 1.0 ? 0.10 : 0.05
    intent_sc = math.abs(intent) * 0.08
    conflict_sc = conflict_score * 0.12
    abs_sc = abs_type == ABS_INTERNAL ? 0.20 : abs_type == ABS_EXTERNAL ? 0.10 : 0.05
    bias_sc = participant == or_bias ? 0.05 : 0.0
    
    base_cps = (part_sc + vol_sc + intent_sc + conflict_sc + abs_sc + bias_sc) * decay
    
    intent_aligned = (participant == BUYER and intent > 0) or (participant == SELLER and intent < 0)
    intent_mult = intent_aligned ? 1.0 + math.min(math.abs(intent) * 0.15, 0.25) : 0.75
    
    abs_mult = 1.0
    if abs_type == ABS_INTERNAL
        abs_mult := 1.3
    else if abs_type == ABS_EXTERNAL
        abs_mult := conflict_score > 0.4 ? 1.15 : 0.95
    
    cps = base_cps * intent_mult * abs_mult
    cps := math.max(0.0, math.min(1.0, cps))
    
    contra_move = (participant == SELLER and close > move1_ext) or (participant == BUYER and close < move1_ext)
    
    if contra_move and abs_type == ABS_INTERNAL and cps >= cps_threshold and intent_aligned
        if participant == SELLER and sig_dir != 1
            sig_dir := 1
            sig_type := "CONTINUATION"
        else if participant == BUYER and sig_dir != -1
            sig_dir := -1
            sig_type := "CONTINUATION"
    
    if contra_move and abs_type == ABS_EXTERNAL and cps >= cps_threshold + 0.10 and conflict_score > 0.4
        if participant == SELLER and sig_dir != 1
            sig_dir := 1
            sig_type := "REVERSAL"
        else if participant == BUYER and sig_dir != -1
            sig_dir := -1
            sig_type := "REVERSAL"
    
    flip_threshold = 50
    if bars_since_def > flip_threshold
        strong_contra = participant == SELLER ? close > defended : close < defended
        if strong_contra and math.abs(intent) < 0.2
            participant := participant == SELLER ? BUYER : SELLER
            defended := close
            move1_ext := participant == SELLER ? low : high
            intent := 0.0
            abs_type := ABS_NONE
            conflict_score := 0.0

hist_val = participant == BUYER ? cps : participant == SELLER ? -cps : 0.0

buy_sig = sig_dir == 1 and sig_dir[1] != 1
sell_sig = sig_dir == -1 and sig_dir[1] != -1

h_col = math.abs(hist_val) >= cps_threshold ? (hist_val > 0 ? color.new(color.lime, 10) : color.new(color.red, 10)) : (hist_val > 0 ? color.new(color.green, 60) : color.new(color.red, 60))

plot(show_histogram ? hist_val : na, "CPS", color=h_col, style=plot.style_columns, linewidth=5)
hline(cps_threshold, "Continuation Zone", color.new(color.lime, 60), linestyle=hline.style_dashed)
hline(-cps_threshold, "Continuation Zone", color.new(color.red, 60), linestyle=hline.style_dashed)
hline(0, "Neutral", color.new(color.gray, 70))

sig_ema = ta.ema(hist_val, 3)
plot(sig_ema, "Signal", color.new(color.orange, 0), linewidth=2)

cont_shape = sig_type == "CONTINUATION"
rev_shape = sig_type == "REVERSAL"

plotshape(buy_sig and cont_shape and show_signals ? -0.6 : na, "Long Cont", shape.triangleup, location.absolute, color.new(color.lime, 0), size=size.normal)
plotshape(sell_sig and cont_shape and show_signals ? 0.6 : na, "Short Cont", shape.triangledown, location.absolute, color.new(color.red, 0), size=size.normal)

plotshape(buy_sig and rev_shape and show_signals ? -0.7 : na, "Long Rev", shape.circle, location.absolute, color.new(color.aqua, 20), size=size.small)
plotshape(sell_sig and rev_shape and show_signals ? 0.7 : na, "Short Rev", shape.circle, location.absolute, color.new(color.fuchsia, 20), size=size.small)

bgcolor(abs_type == ABS_INTERNAL ? color.new(color.blue, 95) : abs_type == ABS_EXTERNAL ? color.new(color.purple, 95) : na)

alertcondition(buy_sig and cont_shape, "HORC Continuation Long", "Continuation Long")
alertcondition(sell_sig and cont_shape, "HORC Continuation Short", "Continuation Short")
alertcondition(buy_sig and rev_shape, "HORC Reversal Long", "Reversal Long")
alertcondition(sell_sig and rev_shape, "HORC Reversal Short", "Reversal Short")

var table tbl = table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 85))
if barstate.islast
    table.cell(tbl, 0, 0, "HORC v6.1-C", text_color=color.white, text_size=size.normal)
    table.cell(tbl, 1, 0, "CONT", text_color=color.lime, text_size=size.small)
    
    table.cell(tbl, 0, 1, "Participant", text_color=color.gray, text_size=size.small)
    p_txt = participant == BUYER ? "BUYER" : participant == SELLER ? "SELLER" : "NONE"
    p_col = participant == BUYER ? color.green : participant == SELLER ? color.red : color.gray
    table.cell(tbl, 1, 1, p_txt, text_color=p_col, text_size=size.small)
    
    table.cell(tbl, 0, 2, "OR Bias", text_color=color.gray, text_size=size.small)
    bias_txt = or_bias == BUYER ? "BUYER" : or_bias == SELLER ? "SELLER" : "NONE"
    table.cell(tbl, 1, 2, bias_txt, text_color=color.gray, text_size=size.small)
    
    table.cell(tbl, 0, 3, "Absorption", text_color=color.gray, text_size=size.small)
    abs_txt = abs_type == ABS_INTERNAL ? "INTERNAL" : abs_type == ABS_EXTERNAL ? "EXTERNAL" : "NONE"
    abs_col = abs_type == ABS_INTERNAL ? color.lime : abs_type == ABS_EXTERNAL ? color.purple : color.gray
    table.cell(tbl, 1, 3, abs_txt, text_color=abs_col, text_size=size.small)
    
    table.cell(tbl, 0, 4, "Conflict", text_color=color.gray, text_size=size.small)
    table.cell(tbl, 1, 4, str.tostring(math.round(conflict_score * 100)) + "%", text_color=conflict_score > 0.4 ? color.orange : color.gray, text_size=size.small)
    
    table.cell(tbl, 0, 5, "Intent", text_color=color.gray, text_size=size.small)
    int_col = intent > 0.2 ? color.green : intent < -0.2 ? color.red : color.gray
    table.cell(tbl, 1, 5, str.tostring(math.round(intent * 100) / 100), text_color=int_col, text_size=size.small)
    
    table.cell(tbl, 0, 6, "CPS", text_color=color.gray, text_size=size.small)
    cps_col = cps >= cps_threshold ? color.lime : color.gray
    table.cell(tbl, 1, 6, str.tostring(math.round(cps * 100)) + "%", text_color=cps_col, text_size=size.small)
