//@version=6
indicator("HORC v6.1-C", overlay=false, max_bars_back=500)

cps_threshold = input.float(0.35, "CPS Threshold", minval=0.2, maxval=0.7, step=0.05)
use_fx_sessions = input.bool(true, "FX Sessions", group="Sessions")
london_start = input.session("0800-0830", "London OR", group="Sessions")
ny_start = input.session("1400-1430", "NY OR", group="Sessions")

NONE = 0
BUYER = 1
SELLER = -1

var float orh = na
var float orl = na
var bool or_done = false
var int or_bar = na

var int participant = NONE
var float defended = na
var float move_ext = na
var float retrace_pt = na
var bool absorbed = false

var float intent = 0.0
var float emission = 0.0

is_new_day = ta.change(time("D")) != 0
in_london = use_fx_sessions and not na(time(timeframe.period, london_start))
in_ny = use_fx_sessions and not na(time(timeframe.period, ny_start))
in_or = in_london or in_ny

atr = ta.atr(14)
vol_avg = ta.sma(volume, 20)
vol_rat = vol_avg > 0 ? volume / vol_avg : 1.0

if is_new_day
    orh := na
    orl := na
    or_done := false
    or_bar := na
    participant := NONE
    defended := na
    move_ext := na
    retrace_pt := na
    absorbed := false
    intent := 0.0
    emission := 0.0

if in_or and not or_done
    orh := na(orh) ? high : math.max(orh, high)
    orl := na(orl) ? low : math.min(orl, low)

if not na(orh) and not na(orl) and not in_or and not or_done and orh > orl
    or_done := true
    or_bar := bar_index

if or_done and participant == NONE
    bars_post = bar_index - or_bar
    if bars_post >= 1 and bars_post <= 5
        swept_l = low <= orl
        swept_h = high >= orh
        
        if swept_l and not swept_h
            participant := SELLER
            defended := orl
            move_ext := low
        else if swept_h and not swept_l
            participant := BUYER
            defended := orh
            move_ext := high
        else if swept_l and swept_h
            l_pen = orl - low
            h_pen = high - orh
            if l_pen > h_pen
                participant := SELLER
                defended := orl
                move_ext := low
            else
                participant := BUYER
                defended := orh
                move_ext := high

if participant != NONE
    if participant == SELLER
        if low < move_ext
            move_ext := low
    else
        if high > move_ext
            move_ext := high
    
    body = math.abs(close - open)
    rng = high - low
    body_rat = rng > 0 ? body / rng : 0.5
    upper_wick = high - math.max(open, close)
    lower_wick = math.min(open, close) - low
    
    exhaust = 0.0
    if participant == SELLER
        wick_sc = rng > 0 ? upper_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    else
        wick_sc = rng > 0 ? lower_wick / rng : 0
        exhaust := (1.0 - body_rat) * 0.5 + wick_sc * 0.5
    
    if exhaust > 0.4 and rng > atr * 0.4 and not absorbed
        retrace_pt := participant == SELLER ? high : low
        
        if not na(defended) and not na(move_ext)
            dist_to_def = math.abs(retrace_pt - defended)
            move_size = math.abs(move_ext - defended)
            retrace_rat = move_size > 0 ? dist_to_def / move_size : 0.5
            
            if retrace_rat < 0.5
                absorbed := true
    
    force = 0.0
    if participant == SELLER
        force := (defended - close) / atr if atr > 0 else 0
    else
        force := (close - defended) / atr if atr > 0 else 0
    
    intent += force * 0.1
    intent *= 0.995
    
    displacement = math.abs(close - close[1])
    vol_delta = volume - vol_avg
    emission := displacement > 0 ? vol_delta / displacement : 0.0
    
    bars_since = bar_index - or_bar
    decay = math.max(0.0, 1.0 - bars_since / 100.0)
    
    part_sc = 0.30
    vol_sc = vol_rat > 1.3 ? 0.15 : vol_rat > 1.0 ? 0.10 : 0.05
    intent_sc = math.abs(intent) * 0.10
    abs_sc = absorbed ? 0.25 : 0.0
    
    base_cps = (part_sc + vol_sc + intent_sc + abs_sc) * decay
    
    intent_aligned = (participant == BUYER and intent > 0) or (participant == SELLER and intent < 0)
    intent_mult = intent_aligned ? 1.0 + math.min(math.abs(intent) * 0.15, 0.25) : 0.75
    
    abs_mult = absorbed ? 1.3 : 1.0
    
    cps = base_cps * intent_mult * abs_mult
    cps := math.max(0.0, math.min(1.0, cps))

hist_val = participant == BUYER ? cps : participant == SELLER ? -cps : 0.0

contra_move = (participant == SELLER and close > move_ext) or (participant == BUYER and close < move_ext)
buy_sig = contra_move and participant == SELLER and absorbed and cps >= cps_threshold and intent_aligned
sell_sig = contra_move and participant == BUYER and absorbed and cps >= cps_threshold and intent_aligned

h_col = math.abs(hist_val) >= cps_threshold ? (hist_val > 0 ? color.new(color.lime, 10) : color.new(color.red, 10)) : (hist_val > 0 ? color.new(color.green, 60) : color.new(color.red, 60))

plot(hist_val, "CPS", color=h_col, style=plot.style_columns, linewidth=5)
hline(cps_threshold, "Long Zone", color.new(color.lime, 60), linestyle=hline.style_dashed)
hline(-cps_threshold, "Short Zone", color.new(color.red, 60), linestyle=hline.style_dashed)
hline(0, "Neutral", color.new(color.gray, 70))

sig_ema = ta.ema(hist_val, 3)
plot(sig_ema, "Signal", color.new(color.orange, 0), linewidth=2)

plotshape(buy_sig ? -0.6 : na, "Long", shape.triangleup, location.absolute, color.new(color.lime, 0), size=size.normal)
plotshape(sell_sig ? 0.6 : na, "Short", shape.triangledown, location.absolute, color.new(color.red, 0), size=size.normal)

bgcolor(absorbed ? color.new(color.blue, 95) : na)

alertcondition(buy_sig, "Long", "HORC Continuation Long")
alertcondition(sell_sig, "Short", "HORC Continuation Short")

var table tbl = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 85))
if barstate.islast
    table.cell(tbl, 0, 0, "HORC v6.1-C", text_color=color.white, text_size=size.normal)
    table.cell(tbl, 1, 0, "CONT", text_color=color.lime, text_size=size.small)
    
    table.cell(tbl, 0, 1, "Participant", text_color=color.gray, text_size=size.small)
    p_txt = participant == BUYER ? "BUYER" : participant == SELLER ? "SELLER" : "NONE"
    p_col = participant == BUYER ? color.green : participant == SELLER ? color.red : color.gray
    table.cell(tbl, 1, 1, p_txt, text_color=p_col, text_size=size.small)
    
    table.cell(tbl, 0, 2, "Absorbed", text_color=color.gray, text_size=size.small)
    abs_txt = absorbed ? "YES" : "NO"
    abs_col = absorbed ? color.lime : color.gray
    table.cell(tbl, 1, 2, abs_txt, text_color=abs_col, text_size=size.small)
    
    table.cell(tbl, 0, 3, "Intent", text_color=color.gray, text_size=size.small)
    int_col = intent > 0.2 ? color.green : intent < -0.2 ? color.red : color.gray
    table.cell(tbl, 1, 3, str.tostring(math.round(intent * 100) / 100), text_color=int_col, text_size=size.small)
    
    table.cell(tbl, 0, 4, "Emission", text_color=color.gray, text_size=size.small)
    em_col = math.abs(emission) > 1000 ? color.orange : color.gray
    table.cell(tbl, 1, 4, str.tostring(math.round(emission)), text_color=em_col, text_size=size.small)
    
    table.cell(tbl, 0, 5, "CPS", text_color=color.gray, text_size=size.small)
    cps_col = cps >= cps_threshold ? color.lime : color.gray
    table.cell(tbl, 1, 5, str.tostring(math.round(cps * 100)) + "%", text_color=cps_col, text_size=size.small)
